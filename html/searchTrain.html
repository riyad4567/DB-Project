<!DOCTYPE html>
<html class="search-bg">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FindTrain</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Rubik:400,700"
    />
    <link rel="stylesheet" href="./style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
        .classfortrainname .totime{
        margin-left: 250px;
        margin-right: 50px;


      }
     .classfortrainname .fromtime{

        margin-left: 100px;
      } 
      #loadingIndicator {
      display: none;
      margin-top: 20px;
    }
    .classfortrainname{
      display:flex;
  
        }
      .ticket-info {
        width: 100%;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        /* padding: 10px; */
        margin-top: 10px;
        margin-right: 30px;
      }
      #table th {
        padding: 8px;
      }

      #table td {
        padding: 8px;
      }

      /* Add spacing for newly added data rows */
      .new-data-row {
        margin-top: 10px; /* Adjust this value as needed */
      }

      .ticket-info.visible {
        opacity: 1; /* Make the div visible with full opacity */
        max-height: 1000px; /* Allow the content to expand to its full height */
      }
      .train-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        margin-left: 20px;
       
        /* margin-right: auto; */
      }
      .train-container2 {
        display: flex;
        align-items: center;
        justify-content: space-around;
        margin-bottom: 20px;
        transition: transform 0.4s;
        background-color: aqua;
        width: 900px;
        margin-left: 100px;
      }
      .train-container2 h1 {
        margin-right: 400px;
      }

      .train-info {
        flex: 1;
      }

      /* .train-name .train-icon {
        /* margin-right: 10px;  */

      .toggle-container {
        /* margin-left: 10px; */
        cursor: pointer;
      }

      .toggle-icon {
        cursor: pointer;
        /* margin-left: 20px; */
      }
      .container .imgbox {
        
        margin-left: 1200px;
        
        position: fixed;
        /* background-color: aquamarine; */
      }
      .imgbox img {
        width: 250px;
        height: 250px;
      }
      .tickpick {
        /* margin-right: 50px; */
        /* flex-basis: 60%; */
        flex-grow: 1;
      }
      .container {
        width: 100%;
        height: auto;
        border-radius: 8px;
        display: flex;
        justify-content: center;
      }
      .ticontainer {
        display: flex;
      }
      .box .seat-button {
        margin-top: 20px;
        margin-left: 30px;
        color: white;
        background: green;
      }
      .option_choose {
        background-color: red;
      }

      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        transition: 200ms ease-in-out;
        border: 1px solid black;
        border-radius: 10px;
        z-index: 10;
        background-color: white;
        width: 500px;
        height: 80%;
        max-width: 80%;
      }

      .modal.active {
        transform: translate(-50%, -50%) scale(1);
      }

      .modal-header {
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid black;
      }

      .modal-header .title {
        font-size: 1.25rem;
        font-weight: bold;
      }

      .modal-header .close-button {
        cursor: pointer;
        border: none;
        outline: none;
        background: none;
        font-size: 1.25rem;
        font-weight: bold;
      }

      .modal-body {
        padding: 10px 15px;
      }
      .trainseat {
        display: flex;
      }

      #overlay {
        position: fixed;
        opacity: 0;
        transition: 200ms ease-in-out;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        pointer-events: none;
      }
      #close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
      }

      #overlay.active {
        opacity: 1;
        pointer-events: all;
      }
      .button .btn {
        background-color: #4caf50; /* Green */
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
      }
       .fortrain {
        margin-left: 20px;
        height:fit-content
      }
      .containerpayment .buttonapp{
        margin-top: 20px;
        background-color:darkgreen;
        color: white;
        padding:5px 10px;
        border-radius: 5px;
        margin-right: 20px;


      }
      .containerpayment .buttoncloseforpayment{

        margin-top: 20px;
        background-color:darkgreen;
        color: white;
        padding:5px 10px;
        border-radius: 5px;
        margin-right: 20px;


      }

    </style>
  </head>

  <body>
    <header class="header">
      <nav class="navbar">
        <a href="index.html">Log Out</a>
        <a href="accountinfo.html">Account Information</a>
        <a href="Purchasehistory.html">History</a>
        <a href="traininformation.html">Transport Information</a>
        <a href="home.html">Home</a>
      </nav>
    </header>
   <div>
    <div class="contentforsearch">
      <div>
      <img
      class="running-train"
      src="https://d19qjkjk65tfln.cloudfront.net/img/train-app/running-train-icon.svg"
      alt="Running Train Animation"
    />
    </div>
      <div class="input-field">
        <input type="text" id="from" placeholder="From" autocomplete="nope">
      </div>
      <div class="input-field">
        <input type="text" id="to" placeholder="To" autocomplete="nope">
      </div>
      <div class="input-field">
        <input type="date" id="date" placeholder="Date" autocomplete="nope">
      </div>
      <div class="button">
        <input type="button" id="modifysearch" value="Search Train" onclick="modifysearch()">
    </div>        
    </div>
    <div id="container" class="container">
      <div class="tickpick" id="ticketpick"></div>
      
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      let timer;
      let timetogive;

// Start or continue the timer
function startOrContinueTimer(durationInSeconds) {
  // Check if the timer state exists in local storage
  const storedTime = localStorage.getItem("timerRemainingTime");

  if (storedTime) {
    // Use the stored time as the initial duration
    durationInSeconds = parseInt(storedTime);
  }

  // Clear any existing timers
  clearInterval(timer);

  // Set up a new timer
  timer = setInterval(async function () {
    console.log("yes");
    // This code will run every second
    timetogive=durationInSeconds;
    console.log(`Time remaining: ${durationInSeconds} seconds`);

    // Decrease the duration
    durationInSeconds--;

    // Store the remaining time in local storage
    localStorage.setItem(
      "timerRemainingTime",
      durationInSeconds.toString()
    );

    // Check if the timer has reached 0
    if (durationInSeconds <= 0) {
      clearInterval(timer);
      console.log("Timer has expired");
      const userId = getCookie("userId");
          const FROM = getCookie("fromstation");
          const TO = getCookie("tostation");
          const DATE = getCookie("date");
          function getSeatBookingFromCookie() {
            const cookieValue = getCookie("seatbook");
            if (cookieValue) {
              try {
                return JSON.parse(decodeURIComponent(cookieValue));
              } catch (error) {
                console.error("Error parsing JSON from cookie:", error);
              }
            }
            return null;
          }

          // Example: Retrieve the seat booking object from the "seatbook" cookie
          const seatbook = getSeatBookingFromCookie();
          const bookingstatus = getCookie("bookingstatus");
          const result = await fetch("http://localhost:3020/finalending", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              bookingstatus: bookingstatus,
              FROM: FROM,
              TO: TO,
              DATE: DATE,
              seatbook: seatbook,
              userId: userId,
            }),
          });

      // Clear the timer state from local storage
      localStorage.removeItem("timerRemainingTime");
    }
  }, 1000); // Timer runs every second (1000 milliseconds)
}
// Retrieve the timer's remaining time from localStorage
const storedTime = localStorage.getItem("timerRemainingTime");

if (storedTime !== null) {
  // Convert the stored time to an integer
  const remainingTime = parseInt(storedTime);

  if (!isNaN(remainingTime) && remainingTime > 0) {
    // Start the timer with the remaining time
    startOrContinueTimer(remainingTime);
  } else {
    // The stored time is invalid or expired; you can handle this case as needed
    console.log("Invalid or expired timer data in localStorage");
  }
} else {
  // No timer data found in localStorage; you can handle this case as needed
  console.log("No timer data found in localStorage");
}

      function getCookie(name) {
      const cookieValue = document.cookie
        .split("; ")
        .find((row) => row.startsWith(name))
        ?.split("=")[1];
      return cookieValue;
    }

    const userId = getCookie("userId");
    const FROM=getCookie("fromstation");
    const TO=getCookie("tostation");
    const DATE=getCookie("date");
    console.log(userId);
    console.log(userId);
      var seatbooking = [];
      var dataadded = 0;
      console.log(FROM+TO+DATE);

      const container = document.getElementById("ticketpick"); //for main container
    async   function modifysearch()
      {
        function formatDateForSQL(inputDate) {
    const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];

    // Parse input date string in 'YYYY-MM-DD' format
    const parts = inputDate.split('-');
    const year = parts[0];
    const monthIndex = parseInt(parts[1], 10) - 1;
    const day = parts[2];

    // Format the date in 'DD-MON-YYYY' format
    const formattedDate = `${day}-${months[monthIndex]}-${year}`;
    
    return formattedDate;
}


  
    var FROM=document.getElementById("from").value;
   FROM=FROM+" Station"


   var TO=document.getElementById("to").value;
   TO=TO+" Station";
   
    var DATE=document.getElementById("date").value;
    document.cookie = `fromstation=${FROM}; path=/;`;
      document.cookie = `tostation=${TO}; path=/;`;
      document.cookie = `date=${formatDateForSQL(DATE)}; path=/;`;

    const result = await fetch("http://localhost:3020/getsetthetrainagin", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userId:userId,
              FROM: FROM,
              TO: TO,
              DATE: formatDateForSQL(DATE),
            }),
          });
          const response=await result.json();

          while (container.firstChild) {
            container.removeChild(container.firstChild);
          }

         
         const loadingIndicator = document.getElementById("container");
         setTimeout(function() {
        // Hide loading indicator
        loadingIndicator.style.display = "none";

        // Refresh the page
        location.reload();
        run();
      }, 1000); // 2000 milliseconds (2 seconds)
    // 2000 milliseconds (2 seconds)
   
          
          
    
}

      function createTicketInfo(element, trainName) {
        const ticketInfoDiv = document.createElement("div");
        ticketInfoDiv.classList.add("ticket-info");

        const str1 =
          "Type: " +
          element.CLASS +
          "\n" +
          "Seat: " +
          element.SEAT_NUMBER
        +"\n"
        +"Fare: "
      +element.FARE
      +"\n";
        const fstr1 = str1.replace(/\n/g, "<br/>");

        const buttonId = trainName + "-" + element.CLASS;

        ticketInfoDiv.innerHTML = `
                               <div class="box">${fstr1}
                                <button id="${buttonId}"class="seat-button"> BOOK </button></div>
                             `;

        return ticketInfoDiv;
      }

      async function seatInformation(Class, coachresponse, trainName) {
        seatbooking = [];
        dataadded = 0;

        const trainseatpaymentdiv = document.getElementById(
          trainName + "seat" + "payment"
        );

        const trainseatdiv = document.getElementById(trainName + "seat");
        const maintraindiv = document.getElementById("div" + trainName);

        if (maintraindiv.contains(trainseatpaymentdiv)) {
          if (trainseatpaymentdiv.contains(trainseatdiv))
            trainseatpaymentdiv.removeChild(trainseatdiv);

          maintraindiv.removeChild(trainseatpaymentdiv);
        }

        const trainseatpaymentdiv2 = document.createElement("div");
        trainseatpaymentdiv2.classList.add("payment");
        trainseatpaymentdiv2.id = trainName + "seat" + "payment";
        const divforpayment = document.createElement("div");
        divforpayment.classList.add("paymentdiv");
        divforpayment.id = trainName + "payment";
        var name = "table" + trainName;
        divforpayment.innerHTML = `
                        <div class="containerpayment">
              <h1>Seat Details</h1>
              <table id="table">
                <tr>
                  <th>Class</th>
                  <th>Seats</th>
                  <th>Fare</th>
                </tr>
                <!-- This row will be populated by backend data -->
              </table>
              <div class="total-box">
                <p>Total: <span id="totalFare">৳ 0.00</span></p>
                <p><i>Child seat fare will be adjusted on the next page</i></p>
                <p><b>Boarding Station *</b><br />${FROM}</p>
              </div>
              <!-- <form id="inputForm">
                <label for="classInput">Class:</label>
                <input type="text" id="classInput" required /><br />
                <label for="seatInput">Seat:</label>
                <input type="text" id="seatInput" required /><br />
                <label for="fareInput">Fare:</label>
                <input type="number" id="fareInput" step="0.01" required /><br />

              </form> -->
              <button class="buttonapp" type="submit" id="paymentapp">payment</button>
              <button class="buttoncloseforpayment" id="close-${trainName}">Close</button>
            </div>

                        `;
        let totalFare = 0;
        const trainseat = document.createElement("div");
        trainseat.classList.add("trainseat2");
        trainseat.id = trainName + "seat";
        const coachdivcreated = document.getElementById("coach" + trainName);
        //console.log(maintraindiv.id);

        const divforcoachname = document.createElement("div");
        divforcoachname.classList.add("seat-container");
        const levelforcoach = document.createElement("level");
        levelforcoach.innerText = "SELECT A COACH:";
        const selectoptions = document.createElement("select");

        divforcoachname.appendChild(levelforcoach);
        const coachdiv = document.createElement("div");

        coachdiv.id = "coach" + trainName;
        //console.log(coachresponse);
        var firstone,
          indicator = 0;

        // console.log(coachresponse);
        // console.log("no");
        //here adding the different coach optionnn
        coachresponse.forEach((value) => {
          const option = document.createElement("option");
          option.id = trainName + "bhai";
          option.classList.add("option_choose");
          option.textContent = value.COACH_NAME;
          option.value = trainName + "-" + Class + "-" + value.COACH_NAME;
          if (indicator == 0) {
            firstone = coachresponse[0];
            indicator = 1;
          } // Set the text content of the option
          selectoptions.appendChild(option);
          // Append the option to the select element
        });
        divforcoachname.appendChild(selectoptions);
        coachdiv.appendChild(divforcoachname);
        //console.log(firstone);

        trainseat.appendChild(coachdiv);
        //console.log(coachresponse);s
        var seatconfigure = document.createElement("div");
        // seatconfigure.id = "bhai" + trainName;
        var indexone = 0;

        //for seeing the firstone in the configure--------------------------------->>
        firstone.seats.forEach((value) => {
          const seatrowproperty = document.createElement("div");
          seatrowproperty.classList.add("row");
          var index2 = 0;

          value.forEach((seatValue) => {
            const seat = document.createElement("div");
            seat.classList.add("seat");
            const seatContent = document.createElement("div");
            seatContent.classList.add("seat-content");
            seatContent.textContent = firstone.seats2[indexone][index2];
            seat.setAttribute(
              "data-seat-id",
              firstone.seats2[indexone][index2]
            );

            seat.appendChild(seatContent);
            if (seatValue == 1) seat.classList.add("sold");
        //     else if (seatValue == 2) {
        //     seat.classList.add("na");
        //    // alert("please wait for 2 minues");
        // }
            seatrowproperty.appendChild(seat);

            index2 = index2 + 1;
            const seatId = seat.getAttribute("data-seat-id");

            seat.addEventListener("click", async function () {





                    const result = await fetch(
                    "http://localhost:3020/persontocheckbook",
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        userId:userId,
                        trainName: trainName,
                        Class: Class,
                        seatId: seatId,
                        FROM:FROM,
                        TO:TO,
                        DATE:DATE,
                      }),
                    }
                  );
          const response = await result.json();
          console.log(response);
console.log("yes1");

if(response.status=="notok"){

  alert("you have to wait for "+timetogive+" seconds");

}





else{


              const result = await fetch(
                    "http://localhost:3020/checkforbookedticket",
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        userId:userId,
                        trainName: trainName,
                        Class: Class,
                        seatId: seatId,
                        FROM:FROM,
                        TO:TO,
                        DATE:DATE,
                      }),
                    }
                  );
          const response = await result.json();
          console.log(response);


if(response.status=="notok"){
  alert("cannot book as you have booked tickets for alreasdy for payment")

}



            
else{
              if (
                !seat.classList.contains("sold") &&
                dataadded < 4 &&
                !seat.classList.contains("na") &&
                dataadded < 4
              ) {
                try {
                  console.log("yes2");
                  dataadded = dataadded + 1;
                  const result = await fetch(
                    "http://localhost:3020/seatbooking",
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        userId:userId,
                        trainName: trainName,
                        Class: Class,
                        seatId: seatId,
                        FROM:FROM,
                        TO:TO,
                        DATE:DATE,
                      }),
                    }
                  );
                  const seatr = seat.getAttribute("data-seat-id");

                  // Extract the seat number from seatId
                  const seatNumber = parseInt(seatr.split("-")[1]);
                  //console.log(seatNumber);

                  const response = await result.json();
                  //console.log(response.rows[0].FARE);

                  const fareInput = parseFloat(response.rows[0].FARE);
                  const table = document.getElementById("table");
                  const closeButton = document.getElementById("closeButton");
                  const totalFareSpan = document.getElementById("totalFare");

                  const newRow = document.createElement("tr");
                  newRow.setAttribute("id", seatId);
                  newRow.innerHTML = `
        <td>${Class}</td>
        <td>${seatId}</td>
        <td>${fareInput.toFixed(2)} BDT</td>
      `;
                  table.appendChild(newRow);

                  // Apply the same styling to the newly added row
                  newRow.querySelectorAll("td").forEach((cell) => {
                    cell.style.padding = "8px"; // Adjust this value as needed
                  });
                  seatbooking.push({
                    trainName: trainName,
                    Class: Class,
                    seatId: seatId,
                    fareInput: fareInput,
                  });

                  // Add spacing for the newly added row
                  newRow.classList.add("new-data-row");

                  // Update total fare and display
                  totalFare += fareInput;
                  totalFareSpan.textContent = `৳ ${totalFare.toFixed(2)}`;
                  seat.classList.add("na");
                  // console.log(coachresponse[0].seats);
                  var row = parseInt(seatNumber / 4);
                  var column = parseInt((seatNumber % 4) - 1); //seatNumber---->
                  //console.log(column);
                  if (seatNumber % 4 == 0) {
                    row = seatNumber / 4 - 1;
                    column = 3;
                  }
                  // console.log(row);
                  // console.log(column);
                  // console.log(coachresponse[0].seats);

                  if (
                    coachresponse[0].seats[row] &&
                    coachresponse[0].seats[row][column] !== undefined
                  ) {
                    coachresponse[0].seats[row][column] = 2;
                    //console.log(coachresponse);
                  }
                  //alert(`Seat ${seatId} booked successfully!`)

                  //window.location.href = "http://localhost:3020/coachInformation";
                } catch (error) {
                  console.error(error);
                  throw error;
                }
              } else if (seat.classList.contains("na")) {
                const totalFareSpan = document.getElementById("totalFare");
                //totalFareSpan.textContent = `৳ ${totalFare.toFixed(2)}`;
                // Assuming you want to delete the fare input of a seat with seatId 'TA-3'
                // Replace with the seatId you want to delete

                // Find the index of the object in the array
                const i = seatbooking.findIndex(
                  (booking) => booking.seatId === seatId
                );

                if (i !== -1) {
                  // Remove the object from the array
                  const deletedFareInput = seatbooking[i].fareInput; // Get the fareInput value
                  seatbooking.splice(i, 1);
                  console.log(deletedFareInput);

                  // Update the total fare by subtracting the deleted fare input
                  totalFare -= deletedFareInput;
                  totalFareSpan.textContent = `৳ ${totalFare.toFixed(2)}`;

                  // Find and remove the corresponding row from the table
                  const rowToDelete = document.getElementById(seatId);
                  if (rowToDelete) {
                    rowToDelete.remove();
                  }
                }

                const seatr = seat.getAttribute("data-seat-id");

                // Extract the seat number from seatId
                const seatNumber = parseInt(seatr.split("-")[1]);
                var row = parseInt(seatNumber / 4);
                var column = parseInt((seatNumber % 4) - 1); //seatNumber---->
                //console.log(column);
                if (seatNumber % 4 == 0) {
                  row = seatNumber / 4 - 1;
                  column = 3;
                }
                // console.log(row);
                // console.log(column);
                // console.log(coachresponse[0].seats);

                if (
                  coachresponse[0].seats[row] &&
                  coachresponse[0].seats[row][column]==2
                ) {
                  coachresponse[0].seats[row][column] = 0;
                  

                  //console.log(coachresponse);
                }
                seat.classList.remove("na");

                
                dataadded = dataadded - 1;
              } else {
                if (dataadded > 4) {
                  alert("Maximum 4 ticket can be booked");
                } else alert(`Seat ${seatId} is not available.`);
              }
            }
            
          }
        }
            
            );////
          });
          indexone = indexone + 1;

          seatconfigure.appendChild(seatrowproperty);
        });

        trainseat.appendChild(seatconfigure);

        //for seeeing the all other options------------->>
        document.addEventListener("change", async (event) => {
          console.log("no");
          if (trainseat.contains(seatconfigure))
            trainseat.removeChild(seatconfigure);
          while (seatconfigure.firstChild) {
            seatconfigure.removeChild(seatconfigure.firstChild);
          }

          seatconfigure = document.createElement("div");
          seatconfigure.classList.add("seat-configure");
          seatconfigure.id = "bhai" + trainName;

          const selectvalue = event.target.value;
          //const selectid=event.target.id;

          const [trainname, Class, COACH_NAME] = selectvalue.split("-");
          //console.log(trainname, Class, COACH_NAME);
          //console.log(coachresponse);
          console.log(trainName, Class, COACH_NAME);
          const indexToUpdate = coachresponse.findIndex(
            (config) => config.COACH_NAME === COACH_NAME
          );
          const foundSeatConfig = coachresponse.find(
            (config) => config.COACH_NAME == COACH_NAME
          );

          //console.log(foundSeatConfig.seats);
          const table = document.getElementById("table");
          const totalFareSpan = document.getElementById("totalFare");

          // const rows = document.getElementById("table");
          // for (let i = rows.length - 1; i > 0; i--) {
          //   table.removeChild(rows[i]);
          // }

          // // Reset total fare and display
          // var totalFare = 0;
          // totalFareSpan.textContent = `৳ ${totalFare.toFixed(2)}`;

          seatconfigure.classList.add("containerSeat");
          var index = 0;
          if (foundSeatConfig.seats) {
            foundSeatConfig.seats.forEach((value) => {
              const seatrowproperty = document.createElement("div");
              seatrowproperty.classList.add("row");
              var index2 = 0;

              value.forEach((seatValue) => {
                const seat = document.createElement("div");
                seat.classList.add("seat");
                const seatContent = document.createElement("div");
                seatContent.classList.add("seat-content");
                seatContent.textContent = foundSeatConfig.seats2[index][index2];
                seat.setAttribute(
                  "data-seat-id",
                  foundSeatConfig.seats2[index][index2]
                );

                seat.appendChild(seatContent);
                if (seatValue == 1) seat.classList.add("sold");
                else if (seatValue == 2) seat.classList.add("na");
                seatrowproperty.appendChild(seat);

                index2 = index2 + 1;
                const seatId = seat.getAttribute("data-seat-id");
                seat.addEventListener("click", async function () {
                  console.log("yes2");


                  const result = await fetch(
                    "http://localhost:3020/checkforbookedticket",
                    {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        userId:userId,
                        trainName: trainName,
                        Class: Class,
                        seatId: seatId,
                        FROM:FROM,
                        TO:TO,
                        DATE:DATE,
                      }),
                    }
                  );
          const response = await result.json();
          console.log(response);


if(response.status=="notok"){
  alert("cannot book as you have booked tickets for alreasdy for payment")

}


else{
                  if (
                    !seat.classList.contains("sold") &&
                    dataadded < 4 &&
                    !seat.classList.contains("na") &&
                    dataadded < 4
                  ) {
                    try {
                      dataadded = dataadded + 1;
                      const result = await fetch(
                        "http://localhost:3020/seatbooking",
                        {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify({
                            userId:userId,
                            trainName: trainName,
                            Class: Class,
                            seatId: seatId,
                            FROM:FROM,
                        TO:TO,
                        DATE:DATE,
                          }),
                        }
                      );
                      console.log(Class, trainName, seatId);
                      const response = await result.json();
                      //console.log(response.rows[0].FARE);
                      const seatr = seat.getAttribute("data-seat-id");

                      // Extract the seat number from seatId
                      const seatNumber = parseInt(seatr.split("-")[1]);
                      //console.log(seatNumber);

                      const fareInput = parseFloat(response.rows[0].FARE);
                      const table = document.getElementById("table");
                      const closeButton =
                        document.getElementById("closeButton");
                      const totalFareSpan =
                        document.getElementById("totalFare");

                      const newRow = document.createElement("tr");
                      newRow.setAttribute("id", seatId);
                      newRow.innerHTML = `
        <td>${Class}</td>
        <td>${seatId}</td>
        <td>${fareInput.toFixed(2)} BDT</td>
      `;
                      table.appendChild(newRow);

                      // Apply the same styling to the newly added row
                      newRow.querySelectorAll("td").forEach((cell) => {
                        cell.style.padding = "8px"; // Adjust this value as needed
                      });

                      // Add spacing for the newly added row
                      newRow.classList.add("new-data-row");
                      seatbooking.push({
                        trainName: trainName,
                        Class: Class,
                        seatId: seatId,
                        fareInput: fareInput,
                      });

                      // Update total fare and display
                      totalFare += fareInput;
                      totalFareSpan.textContent = `৳ ${totalFare.toFixed(2)}`;
                      seat.classList.add("na");
                      var row = parseInt(seatNumber / 4);
                      var column = parseInt((seatNumber % 4) - 1); //seatNumber---->
                      //console.log(column);
                      if (seatNumber % 4 == 0) {
                        row = seatNumber / 4 - 1;
                        column = 3;
                      }
                      // console.log(row);
                      // console.log(column);
                      // console.log(coachresponse[0].seats);

                      if (
                        coachresponse[indexToUpdate].seats[row] &&
                        coachresponse[indexToUpdate].seats[row][column] !==
                          undefined
                      ) {
                        coachresponse[indexToUpdate].seats[row][column] = 2;
                        console.log(coachresponse);
                      }

                      //alert(`Seat ${seatId} booked successfully!`);

                      //window.location.href = "http://localhost:3020/coachInformation";
                    } catch (error) {
                      console.error(error);
                      throw error;
                    }
                  } else if (seat.classList.contains("na")) {
                    const totalFareSpan = document.getElementById("totalFare");
                    //totalFareSpan.textContent = `৳ ${totalFare.toFixed(2)}`;
                    // Assuming you want to delete the fare input of a seat with seatId 'TA-3'
                    // Replace with the seatId you want to delete

                    // Find the index of the object in the array
                    const i = seatbooking.findIndex(
                      (booking) => booking.seatId === seatId
                    );

                    if (i !== -1) {
                      // Remove the object from the array
                      const deletedFareInput = seatbooking[i].fareInput;
                      console.log(seatbooking[i]); // Get the fareInput value
                      seatbooking.splice(i, 1);
                      console.log(deletedFareInput);

                      // Update the total fare by subtracting the deleted fare input
                      totalFare -= deletedFareInput;
                      totalFareSpan.textContent = `৳ ${totalFare.toFixed(2)}`;

                      // Find and remove the corresponding row from the table
                      const rowToDelete = document.getElementById(seatId);
                      if (rowToDelete) {
                        rowToDelete.remove();
                      }
                    }

                    const seatr = seat.getAttribute("data-seat-id");

                    // Extract the seat number from seatId
                    const seatNumber = parseInt(seatr.split("-")[1]);
                    var row = parseInt(seatNumber / 4);
                    var column = parseInt((seatNumber % 4) - 1); //seatNumber---->
                    //console.log(column);
                    if (seatNumber % 4 == 0) {
                      row = seatNumber / 4 - 1;
                      column = 3;
                    }
                    // console.log(row);
                    // console.log(column);
                    // console.log(coachresponse[0].seats);

                    if (
                      coachresponse[indexToUpdate].seats[row] &&
                      coachresponse[indexToUpdate].seats[row][column] !==
                        undefined
                    ) {
                      coachresponse[indexToUpdate].seats[row][column] = 0;
                      //console.log(coachresponse);
                    }

                    seat.classList.remove("na");

                    dataadded = dataadded - 1;
                  } else {
                    if (dataadded > 4) {
                      alert("Maximum 4 ticket can be booked");
                    } else alert(`Seat ${seatId} is not available.`);
                  }
                }
                
              }
                
                );
              });
              index = index + 1;

              seatconfigure.appendChild(seatrowproperty);
            });

            trainseat.appendChild(seatconfigure);

            console.log("Added new seatconfigure."); //1
          }
        });

        trainseatpaymentdiv2.appendChild(trainseat);
        trainseatpaymentdiv2.appendChild(divforpayment);
        maintraindiv.appendChild(trainseatpaymentdiv2);
      }
      async function paymentproceed() {
        document.addEventListener("click", async (event) => {
          if (event.target.classList.contains("buttonapp")) {


            try{
            const result = await fetch(
                        "http://localhost:3020/paymentproceed",
                        {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify({
                            userId:userId,
                            seatbook:seatbooking,
                            FROM:FROM,
                        TO:TO,
                        DATE:DATE,
                          }),
                        }
                      );
                      const vae="no"
                      const serializedSeatBooking = JSON.stringify(seatbooking);

// Set the cookie with the serialized JSON value
document.cookie = `seatbook=${encodeURIComponent(serializedSeatBooking)}; path=/;`;
                      document.cookie = `bookingstatus=${vae}; path=/;`;
                     
                      // Set the timer duration in local storage
const timerDuration = 30; // 5 minutes
localStorage.setItem('timerRemainingTime', timerDuration);


            window.location.href = "payment.html";
                      }catch(error)
                      {
                        console.log(error);
                      }
          }
        });
      }

      async function coachInformation() {
        document.addEventListener("click", async (event) => {
          if (event.target.classList.contains("seat-button")) {
            try {
              const buttonid = event.target.id;
              console.log(buttonid);
              const [trainname, Class] = buttonid.split("-");
              //console.log(trainName, Class);
              trainName = trainname;

              const result = await fetch(
                "http://localhost:3020/coachInformation",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    userId:userId,
                    trainName: trainName,
                    Class: Class,
                    FROM:FROM,
                        TO:TO,
                        DATE:DATE,
                  }),
                }
              );
              coachresponse = await result.json();
              console.log(coachresponse);
              console.log("yes");
              seatInformation(Class, coachresponse, trainName);
              //window.location.href = "http://localhost:3020/coachInformation";
            } catch (error) {
              console.error(error);
              throw error;
            }
          }
        });
      }
      function openModal(modal, overlay) {
        if (modal == null) return;
        modal.classList.add("active");
        console.log("yes");
        overlay.classList.add("active");
      }

      function closeModal(modal, overlay) {
        if (modal == null) return;
        modal.classList.remove("active");
        console.log("np");
        overlay.classList.remove("active");
      }

      async function buttondtraindetails() {
        document.addEventListener("click", async (event) => {
          if (event.target.classList.contains("fortrain")) {
            try {
              const buttonid = event.target.id;
              console.log(buttonid);
              const [trainname, Class] = buttonid.split("%");
              console.log(trainname, Class);
              const trainName = trainname;

              const result = await fetch("http://localhost:3020/traindetails", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  userId:userId,
                  trainName: trainName,
                  FROM:FROM,
                  TO:TO,
                  DATE:DATE,
                  //Class: Class,
                }),
              });
              const trainDetails = await result.json();
              console.log(trainDetails);
              //const modal = document.getElementById(buttonid).closest(".modal");
              const modalBody = document.getElementById(
                "modal-body" + trainName
              );
              trainDetails.forEach((dataEntry) => {
                const visitTime = dataEntry.VISIT_TIME;
                const intervalStation = dataEntry.INTERVAL_STATION;

                // Create an HTML element to display the data
                const dataEntryElement = document.createElement("p");
                dataEntryElement.textContent = `Visit Time: ${visitTime}, Interval Station: ${intervalStation}`;

                // Append the element to the modal body
                modalBody.appendChild(dataEntryElement);
              });

              // Open the modal
              const overlay = document.getElementById("overlay" + trainName);
              const modal = document.getElementById("modal" + trainName);
              // const infoModal = document.getElementById("infoModal");
              console.log(modal);

              openModal(modal, overlay);

              const closeModalButton = document.getElementById(
                "close" + trainName
              );
              closeModalButton.addEventListener("click", () => {
                closeModal(modal, overlay);
                while (modalBody.firstChild) {
                  modalBody.removeChild(modalBody.firstChild);
                }
              });

              //seatInformation(Class, coachresponse);
              //window.location.href = "http://localhost:3020/coachInformation";
            } catch (error) {
              console.error(error);
              throw error;
            }
          }
        });
      }

      async function paymentclose() {
        document.addEventListener("click", async (event) => {
          if (event.target.classList.contains("buttoncloseforpayment")) {
            const str = event.target.id;
            console.log(str);
            const [bogijogi, trainName] = str.split("-");
            const t = document.getElementById(trainName);
            t.classList.remove("toggle-icon", "fa-chevron-up");

            t.classList.add("toggle-icon", "fa-chevron-down");
            var divdelete = document.getElementById("ticketof" + trainName);
            var coachdelete = document.getElementById(
              trainName + "seat" + "payment"
            );
            var buttondelete = document.getElementById(trainName + "BUTTON");

            var divfrom = document.getElementById("div" + trainName);
            if (divfrom.contains(coachdelete)) divfrom.removeChild(coachdelete);
            if (divfrom.contains(buttondelete))
              divfrom.removeChild(buttondelete);
            divfrom.removeChild(divdelete);
          }
        });
      }

      async function ticketInformation() {
        document.addEventListener("click", async (event) => {
          if (event.target.classList.contains("fa-chevron-down")) {
            try {
              event.target.classList.remove("fa-chevron-down");
              event.target.classList.add("fa-chevron-up");
              trainName = event.target.id;
              //console.log(trainName);

              const result = await fetch(
                "http://localhost:3020/ticketInformation",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    userId:userId,
                    trainName: trainName,
                    FROM:FROM,
                      TO:TO,
                      DATE:DATE,
                  }),
                }
              );

              if (!result.ok) {
                throw new Error("Network response was not ok");
              }
              const response = await result.json();
              const tickets = response;
              console.log(tickets);
              var div = document.getElementById("div" + trainName);
              const traindetails = document.createElement("div");
              traindetails.classList.add();
              traindetails.id = trainName + "BUTTON";
              var R = trainName + "%" + "button";
              var modalid = "modal" + trainName;
              var overlayid = "overlay" + trainName;
              var closeid = "close" + trainName;
              var divmodalbody = "modal-body" + trainName;
              const result2 = await fetch(
                "http://localhost:3020/trainvisittimeshow",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    userId:userId,
                    trainName: trainName,
                    FROM:FROM,
                        TO:TO,
                        DATE:DATE,
                  }),
                }
              );

              if (!result.ok) {
                throw new Error("Network response was not ok");
              }
              const response2=await result2.json();
              console.log(response2);


              traindetails.innerHTML = `
              <div class="classfortrainname">
                <div class="fromtime"> <h1 >${response2.fromstation}
                  </h1>
                    <h3 >${response2.fromtime}</h3>
                  </div>
                  <div class="totime"> <h1 >${response2.tostation}
                  </h1>
                    <h3 >${response2.totime}</h3>
                  </div>

                              <button id="${R}"  class="fortrain">Train Details</button><div>
                <div class="modal" id="${modalid}">
                  <div class="modal-header">
                    <div class="title">Train Details</div>
                    <button id="${closeid}" class="close-button">&times;</button>
                  </div>
                  <div id="${divmodalbody}" class="modal-body"></div>
                </div>
                <div id="${overlayid}"></div>

                             `;

              div.appendChild(traindetails);

              var ticketcontain = document.createElement("div");
              ticketcontain.classList.add("ticontainer");
              ticketcontain.id = "ticketof" + trainName;

              // //for ticket search
              tickets.forEach(function (element) {
                console.log(element.FARE);
                var newTicketInfoDiv = createTicketInfo(element, trainName);
                ticketcontain.appendChild(newTicketInfoDiv);
              });
              div.appendChild(ticketcontain);
            } catch (error) {
              console.error("An error occurred:", error);
            }
          } else if (event.target.classList.contains("fa-chevron-up")) {
            event.target.classList.remove("toggle-icon", "fa-chevron-up");

            event.target.classList.add("toggle-icon", "fa-chevron-down");

            var divdelete = document.getElementById(
              "ticketof" + event.target.id
            );
            var coachdelete = document.getElementById(
              event.target.id + "seat" + "payment"
            );
            var buttondelete = document.getElementById(
              event.target.id + "BUTTON"
            );

            var divfrom = document.getElementById("div" + event.target.id);
            if (divfrom.contains(coachdelete)) divfrom.removeChild(coachdelete);
            if (divfrom.contains(buttondelete))
              divfrom.removeChild(buttondelete);
            divfrom.removeChild(divdelete);

            //if (div2.contains(contain2)) div2.removeChild(contain2);
          }
        });
      }
      async function trainInformation() {
        try {
          const result = await fetch(
                "http://localhost:3020/trainInformation",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    userId:userId,
                    FROM:FROM,
                        TO:TO,
                        DATE:DATE,
                  }),
                }
              );
          const response = await result.json();
          // Handle the response from the backend
          console.log(response);

          // Parse the JSON data into JavaScript objects
          const train = response;

          train.forEach((element) => {
            const div = document.createElement("div"); //for each traincontainer
            // div.id = element.TRAIN_NAME;
            div.classList.add("train-container"); // Add a class for styling
            div.id = "div" + element.TRAIN_NAME;
            const hi = document.createElement("div");
            hi.id = "hi" + element.TRAIN_NAME;
            hi.classList.add("train-container2");

            const h1 = document.createElement("h1");
            h1.id = "h1" + element.TRAIN_NAME;
            h1.classList.add("train-name");

            h1.innerText = element.TRAIN_NAME;
            const toggleIcon = document.createElement("i");
            toggleIcon.classList.add("toggle-icon", "fas", "fa-chevron-down");
            toggleIcon.id = element.TRAIN_NAME;
            console.log(toggleIcon);
            hi.appendChild(h1);
            hi.appendChild(toggleIcon);

            div.appendChild(hi);

            container.appendChild(div);
          });
        } catch (error) {
          console.error("Error fetching train information:", error);
          throw error;
        }
      }
      
      async function run() {
        try {
          
          await trainInformation();

          await ticketInformation();
          await buttondtraindetails();

          await coachInformation();
          await paymentproceed();
          await paymentclose();
          //await seatInformation();
        } catch (error) {
          console.error("Error during run:", error);
        }
      }
      run();
    </script>
  </body>
</html>
